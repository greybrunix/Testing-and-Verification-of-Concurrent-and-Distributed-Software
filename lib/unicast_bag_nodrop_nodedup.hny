import bag
net = bag.empty()
def send(src, dst, payload):
	var msg = {.src:src,.dst:dst,.payload:payload}
	atomically:
		print("send", msg)
		if bag.multiplicity(net,msg) == 0:
			net = bag.add(net, msg)
def receive(pid) returns msg:
	let msgs = { (m,c) for m:c in net where (m.dst == pid) }:
		if len(msgs) > 0:
			msg = choose(msgs)
			print("receive", msg)
		else:
			msg = 0
