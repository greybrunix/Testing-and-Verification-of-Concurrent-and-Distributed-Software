<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>


<script>

// set the dimensions and margins of the graph
var margin = {top: 30, right: 10, bottom: 10, left: 0},
  width = 500 - margin.left - margin.right,
  height = 400 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
.append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
.append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

// Parse the Data
d3.csv("data.csv", function(data) {

  // Initialize variables to store number os collumns
  var collumns = -Infinity;

  // Iterate over each row
  data.forEach(function(row) {
      var src = parseInt(row.src);
      var dst = parseInt(row.dst);

      if (src > collumns) {
          collumns = src;
      }
      if (dst > collumns) {
          collumns = dst;
      }
  });

  console.log("Max value: " + collumns);

  // Extract the list of dimensions we want to keep in the plot. Here I keep all except the column called Species
  //dimensions = d3.keys(data[0]).filter(function(d) { return d != "Species" })

  var columnNames = d3.range(collumns + 1).map(String);

  var y = {};
columnNames.forEach(function(name) {
    y[name] = d3.scaleLinear()
        .domain([0, collumns])
        .range([height, 0]); // Adjust the range to ensure each row corresponds to one height increment
});

  // Build the X scale -> it find the best position for each Y axis
  var x = d3.scalePoint()
    .range([0, width])
    .padding(1)
    .domain(columnNames);

  // The path function take a row of the csv as input, and return x and y coordinates of the line to draw for this raw.
  function path(d) {
      return d3.line()(columnNames.map(function(p) { return [x(p), y[p](d[p])]; }));
  }

// Draw the lines
svg.selectAll("myPath")
    .data(data.filter(function(d) { return d.type === "send"; }))
    .enter()
    .append("path")
    .attr("d", function(sendRow, index) {
        var pathData = [];
        var correspondingReceive = data.find(function(receiveRow) {
            return receiveRow.type === "receive" && receiveRow.dst === sendRow.dst && receiveRow.id === sendRow.id;
        });
        console.log("Send Row:", sendRow);
        console.log("Corresponding Receive Row:", correspondingReceive);
        if (correspondingReceive) {
            var srcX = x(sendRow.src);
            var srcY = index * 10; // Adjust the height increment as necessary
            var dstX = x(correspondingReceive.dst);
            var dstY = data.indexOf(correspondingReceive) * 10; // Adjust the height increment as necessary
            console.log("Pushing coordinates: ", [srcX, srcY], [dstX, dstY]);
            pathData.push([srcX, srcY], [dstX, dstY]);

            // Calculate angle
            var dx = dstX - srcX;
            var dy = dstY - srcY;
            var angle = Math.atan2(dy, dx) * (180 / Math.PI);

            // Adjust angle based on quadrant
            if (angle > 90 || angle < -90) {
                angle -= 180;
            }

            // Add label
            svg.append("text")
                .attr("x", (srcX + dstX) / 2)
                .attr("y", (srcY + dstY) / 2)
                .text(sendRow.msg)
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .style("fill", "black")
                .style("font-size", "10px") // Adjust font size as needed
                .attr("transform", "rotate(" + angle + "," + ((srcX + dstX) / 2) + "," + ((srcY + dstY) / 2) + ")");
        }
        console.log("Path data: ", pathData);
        return d3.line()(pathData);
    })
    .style("fill", "none")
    .style("stroke", "#69b3a2")
    .style("opacity", 0.5);

  // Draw the axis:
  svg.selectAll("myAxis")
    // For each dimension of the dataset I add a 'g' element:
    .data(columnNames).enter()
    .append("g")
    // I translate this element to its right position on the x axis
    .attr("transform", function(d) { return "translate(" + x(d) + ")"; })
    // And I build the axis with the call function
    .each(function(d) { d3.select(this).call(d3.axisLeft().scale(y[d])); })
    // Add axis title
    .append("text")
      .style("text-anchor", "middle")
      .attr("y", -9)
      .text(function(d) { return d; })
      .style("fill", "black")

});


</script>
